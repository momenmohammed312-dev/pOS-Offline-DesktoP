import 'package:flutter/services.dart' show rootBundle;
import 'package:excel/excel.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';
import 'package:intl/intl.dart';
import 'package:path_provider/path_provider.dart';
import 'package:path/path.dart' as path;
import 'dart:io';
import 'package:pos_offline_desktop/core/database/app_database.dart';

class ExportService {
  static const String _branding = 'Developed by MO2';

  // PDF Export Methods
  Future<void> exportToPDF({
    required String title,
    required List<Map<String, dynamic>> data,
    required List<String> headers,
    required List<String> columns,
    String? fileName,
  }) async {
    final pdf = pw.Document();

    // Try to load Arabic font with fallback
    pw.Font? arabicFont;
    try {
      arabicFont = pw.Font.ttf(await rootBundle.load('assets/fonts/NotoSansArabic-Regular.ttf'));
    } catch (e) {
      // Fallback to default font if Arabic font fails to load
      arabicFont = null;
    }

    pw.Font? arabicBoldFont;
    try {
      arabicBoldFont = pw.Font.ttf(await rootBundle.load('assets/fonts/NotoSansArabic-Bold.ttf'));
    } catch (e) {
      arabicBoldFont = null;
    }

    // Define text style for Arabic with proper font
    final arabicStyle = pw.TextStyle(
      fontSize: 12,
      font: arabicFont,
    );

    final headerStyle = pw.TextStyle(
      fontSize: 14,
      fontWeight: pw.FontWeight.bold,
      font: arabicBoldFont,
    );

    final titleStyle = pw.TextStyle(
      fontSize: 24,
      fontWeight: pw.FontWeight.bold,
      font: arabicBoldFont,
    );

    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.all(32),
        build: (pw.Context context) => pw.Directionality(
          textDirection: pw.TextDirection.rtl,
          child: pw.Column(
            children: [
              // Header
              pw.Center(
                child: pw.Column(
                  children: [
                    pw.Text(
                      title,
                      style: titleStyle,
                      textDirection: pw.TextDirection.rtl,
                    ),
                    pw.SizedBox(height: 8),
                    pw.Text(
                      _branding,
                      style: pw.TextStyle(
                        fontSize: 10,
                        fontStyle: pw.FontStyle.italic,
                      ),
                      textDirection: pw.TextDirection.ltr,
                    ),
                    pw.SizedBox(height: 16),
                    pw.Container(
                      padding: const pw.EdgeInsets.all(8),
                      decoration: pw.BoxDecoration(
                        color: PdfColors.grey100,
                        borderRadius: const pw.BorderRadius.all(
                          pw.Radius.circular(4),
                        ),
                      ),
                      child: pw.Text(
                        'التاريخ: ${DateFormat('yyyy/MM/dd HH:mm').format(DateTime.now())}',
                        style: arabicStyle,
                        textDirection: pw.TextDirection.rtl,
                      ),
                    ),
                  ],
                ),
              ),
              pw.SizedBox(height: 20),

              // Table
              pw.Container(
                decoration: pw.BoxDecoration(
                  border: pw.Border.all(color: PdfColors.grey300),
                  borderRadius: const pw.BorderRadius.all(
                    pw.Radius.circular(4),
                  ),
                ),
                child: pw.Table(
                  border: pw.TableBorder.all(color: PdfColors.grey400),
                  columnWidths: {
                    0: const pw.FlexColumnWidth(1),
                    1: const pw.FlexColumnWidth(2),
                    2: const pw.FlexColumnWidth(1.5),
                    3: const pw.FlexColumnWidth(1.5),
                  },
                  children: [
                    // Header Row
                    pw.TableRow(
                      decoration: const pw.BoxDecoration(
                        color: PdfColors.blue100,
                      ),
                      children: headers.map((header) {
                        return pw.Container(
                          padding: const pw.EdgeInsets.symmetric(
                            vertical: 12,
                            horizontal: 8,
                          ),
                          child: pw.Text(
                            header,
                            style: headerStyle,
                            textAlign: pw.TextAlign.center,
                            textDirection: pw.TextDirection.rtl,
                          ),
                        );
                      }).toList(),
                    ),
                    // Data Rows
                    ...data.asMap().entries.map((entry) {
                      final index = entry.key;
                      final row = entry.value;
                      return pw.TableRow(
                        decoration: pw.BoxDecoration(
                          color: index % 2 == 0
                              ? PdfColors.white
                              : PdfColors.grey50,
                        ),
                        children: columns.map((column) {
                          return pw.Container(
                            padding: const pw.EdgeInsets.symmetric(
                              vertical: 8,
                              horizontal: 8,
                            ),
                            child: pw.Text(
                              _formatCellValue(row[column]),
                              style: arabicStyle,
                              textAlign:
                                  column.contains('amount') ||
                                      column.contains('balance') ||
                                      column.contains('الإجمالي') ||
                                      column.contains('المدفوع') ||
                                      column.contains('المتبقي')
                                  ? pw.TextAlign.left
                                  : pw.TextAlign.center,
                              textDirection: pw.TextDirection.rtl,
                            ),
                          );
                        }).toList(),
                      );
                    }),
                  ],
                ),
              ),

              pw.Expanded(child: pw.Container()),

              // Footer
              pw.Container(
                padding: const pw.EdgeInsets.all(16),
                child: pw.Center(
                  child: pw.Column(
                    children: [
                      pw.Container(
                        padding: const pw.EdgeInsets.symmetric(
                          vertical: 8,
                          horizontal: 16,
                        ),
                        decoration: pw.BoxDecoration(
                          color: PdfColors.grey100,
                          borderRadius: const pw.BorderRadius.all(
                            pw.Radius.circular(4),
                          ),
                        ),
                        child: pw.Text(
                          _branding,
                          style: pw.TextStyle(
                            fontSize: 10,
                            fontStyle: pw.FontStyle.italic,
                          ),
                          textDirection: pw.TextDirection.ltr,
                        ),
                      ),
                      pw.SizedBox(height: 8),
                      pw.Text(
                        'تم الإنشاء في ${DateFormat('yyyy/MM/dd HH:mm').format(DateTime.now())}',
                        style: pw.TextStyle(fontSize: 8),
                        textDirection: pw.TextDirection.rtl,
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );

    // Save and print
    final output = await pdf.save();

    // Try different printing approaches
    try {
      // Method 1: Direct layout
      await Printing.layoutPdf(
        onLayout: (PdfPageFormat format) async => output,
        name: fileName ?? '$title.pdf',
      );
    } catch (e) {
      try {
        // Method 2: Share and print
        await Printing.sharePdf(
          bytes: output,
          filename: fileName ?? '$title.pdf',
        );
      } catch (e2) {
        // Method 3: Save to file and open
        final directory = await getApplicationDocumentsDirectory();
        final filePath = path.join(
          directory.path,
          fileName ??
              '${title}_${DateFormat('yyyyMMdd_HHmmss').format(DateTime.now())}.pdf',
        );
        final file = File(filePath);
        await file.writeAsBytes(output);

        // Try to open the file
        if (await file.exists()) {
          await Printing.sharePdf(
            bytes: await file.readAsBytes(),
            filename: path.basename(filePath),
          );
        }
      }
    }
  }

  // Excel Export Methods
  Future<void> exportToExcel({
    required String title,
    required List<Map<String, dynamic>> data,
    required List<String> headers,
    required List<String> columns,
    String? fileName,
  }) async {
    final excel = Excel.createExcel();
    final sheet = excel['Sheet1'];

    // Style definitions
    final headerStyle = CellStyle(
      bold: true,
      horizontalAlign: HorizontalAlign.Center,
      verticalAlign: VerticalAlign.Center,
      fontSize: 12,
    );

    final dataStyle = CellStyle(
      horizontalAlign: HorizontalAlign.Center,
      verticalAlign: VerticalAlign.Center,
      fontSize: 11,
    );

    final numberStyle = CellStyle(
      horizontalAlign: HorizontalAlign.Left,
      verticalAlign: VerticalAlign.Center,
      fontSize: 11,
    );

    // Add title row at the top
    final titleCell = sheet.cell(
      CellIndex.indexByColumnRow(columnIndex: 0, rowIndex: 0),
    );
    titleCell.value = TextCellValue(title);
    titleCell.cellStyle = CellStyle(
      bold: true,
      fontSize: 16,
      horizontalAlign: HorizontalAlign.Center,
      verticalAlign: VerticalAlign.Center,
    );

    // Merge title cells
    sheet.merge(
      CellIndex.indexByColumnRow(columnIndex: 0, rowIndex: 0),
      CellIndex.indexByColumnRow(columnIndex: columns.length - 1, rowIndex: 0),
    );

    // Add headers in the second row
    for (int i = 0; i < headers.length; i++) {
      final cell = sheet.cell(
        CellIndex.indexByColumnRow(columnIndex: i, rowIndex: 1),
      );
      cell.value = TextCellValue(headers[i]);
      cell.cellStyle = headerStyle;
    }

    // Add data with proper styling
    for (int rowIndex = 0; rowIndex < data.length; rowIndex++) {
      final row = data[rowIndex];
      for (int colIndex = 0; colIndex < columns.length; colIndex++) {
        final cell = sheet.cell(
          CellIndex.indexByColumnRow(
            columnIndex: colIndex,
            rowIndex: rowIndex + 2,
          ),
        );

        final columnName = columns[colIndex];
        final value = row[columnName];

        // Apply appropriate styling based on content type
        if (value is double || value is int) {
          cell.value = DoubleCellValue(value.toDouble());
          cell.cellStyle = numberStyle;
        } else if (value is DateTime) {
          cell.value = DateCellValue(
            year: value.year,
            month: value.month,
            day: value.day,
          );
          cell.cellStyle = dataStyle;
        } else {
          cell.value = TextCellValue(_formatCellValue(value));
          cell.cellStyle = dataStyle;
        }
      }
    }

    // Auto-adjust column widths
    for (int col = 0; col < columns.length; col++) {
      sheet.setColumnAutoFit(col);
    }

    // Add metadata info
    final metadataRow = data.length + 4;
    sheet.merge(
      CellIndex.indexByColumnRow(columnIndex: 0, rowIndex: metadataRow),
      CellIndex.indexByColumnRow(
        columnIndex: columns.length - 1,
        rowIndex: metadataRow,
      ),
    );

    final metadataCell = sheet.cell(
      CellIndex.indexByColumnRow(columnIndex: 0, rowIndex: metadataRow),
    );
    metadataCell.value = TextCellValue(
      '$_branding - تم الإنشاء في ${DateFormat('yyyy/MM/dd HH:mm').format(DateTime.now())}',
    );
    metadataCell.cellStyle = CellStyle(
      fontSize: 10,
      italic: true,
      horizontalAlign: HorizontalAlign.Center,
    );

    // Save file
    final directory = await getApplicationDocumentsDirectory();
    final filePath = path.join(
      directory.path,
      fileName ??
          '${title}_${DateFormat('yyyyMMdd_HHmmss').format(DateTime.now())}.xlsx',
    );

    final file = File(filePath);
    await file.writeAsBytes(excel.save()!);

    // Open file
    await Printing.sharePdf(
      bytes: await file.readAsBytes(),
      filename: path.basename(filePath),
    );
  }

  // Customer Statement PDF
  Future<void> exportCustomerStatement({
    required String customerName,
    required List<Map<String, dynamic>> transactions,
    required double openingBalance,
    required double currentBalance,
  }) async {
    // Validate inputs
    final safeCustomerName = customerName.isNotEmpty
        ? customerName
        : 'عميل غير محدد';
    final safeTransactions = transactions.cast<Map<String, dynamic>>().toList();
    final safeOpeningBalance = openingBalance.isNaN ? 0.0 : openingBalance;
    final safeCurrentBalance = currentBalance.isNaN ? 0.0 : currentBalance;

    final pdf = pw.Document();

    // Load Arabic fonts
    final arabicFont = await pw.Font.ttf(
      await rootBundle.load('assets/fonts/NotoSansArabic-Regular.ttf'),
    );
    final arabicBoldFont = await pw.Font.ttf(
      await rootBundle.load('assets/fonts/NotoSansArabic-Bold.ttf'),
    );

    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.all(32),
        build: (pw.Context context) => pw.Column(
          children: [
            // Header
            pw.Center(
              child: pw.Column(
                children: [
                  pw.Text(
                    'كشف حساب عميل',
                    style: pw.TextStyle(
                      fontSize: 24,
                      fontWeight: pw.FontWeight.bold,
                      font: arabicBoldFont,
                    ),
                  ),
                  pw.Text(_branding),
                  pw.SizedBox(height: 16),
                ],
              ),
            ),

            // Customer Info
            pw.Container(
              padding: const pw.EdgeInsets.all(12),
              decoration: pw.BoxDecoration(
                border: pw.Border.all(),
                borderRadius: const pw.BorderRadius.all(pw.Radius.circular(4)),
              ),
              child: pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Text(
                    'اسم العميل: $safeCustomerName',
                    style: pw.TextStyle(font: arabicFont),
                  ),
                  pw.Text(
                    'التاريخ: ${DateFormat('yyyy/MM/dd').format(DateTime.now())}',
                    style: pw.TextStyle(font: arabicFont),
                  ),
                  pw.SizedBox(height: 8),
                  pw.Row(
                    children: [
                      pw.Expanded(
                        child: pw.Text(
                          'الرصيد الافتتاحي: ${_formatCurrency(safeOpeningBalance)}',
                          style: pw.TextStyle(font: arabicFont),
                        ),
                      ),
                      pw.Expanded(
                        child: pw.Text(
                          'الرصيد الحالي: ${_formatCurrency(safeCurrentBalance)}',
                          style: pw.TextStyle(font: arabicFont),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
            pw.SizedBox(height: 20),

            // Transactions Table
            pw.Table(
              border: pw.TableBorder.all(),
              columnWidths: {
                0: const pw.FlexColumnWidth(1),
                1: const pw.FlexColumnWidth(2.5),
                2: const pw.FlexColumnWidth(1),
                3: const pw.FlexColumnWidth(1),
                4: const pw.FlexColumnWidth(1),
              },
              children: [
                // Header
                pw.TableRow(
                  decoration: const pw.BoxDecoration(color: PdfColors.grey300),
                  children: [
                    _buildHeaderCell('التاريخ'),
                    _buildHeaderCell('الوصف'),
                    _buildHeaderCell('دين'),
                    _buildHeaderCell('دائن'),
                    _buildHeaderCell('الرصيد'),
                  ],
                ),
                // Data
                ...safeTransactions.map((transaction) {
                  return pw.TableRow(
                    children: [
                      _buildDataCell(
                        DateFormat('dd/MM/yyyy').format(transaction['date']),
                      ),
                      _buildDataCell(transaction['description']),
                      _buildDataCell(
                        transaction['debit'] > 0
                            ? _formatCurrency(transaction['debit'])
                            : '',
                      ),
                      _buildDataCell(
                        transaction['credit'] > 0
                            ? _formatCurrency(transaction['credit'])
                            : '',
                      ),
                      _buildDataCell(_formatCurrency(transaction['balance'])),
                    ],
                  );
                }),
              ],
            ),

            pw.Expanded(child: pw.Container()),

            // Footer
            pw.Center(
              child: pw.Column(
                children: [
                  pw.Text(_branding),
                  pw.Text(
                    'تم الإنشاء في ${DateFormat('yyyy/MM/dd HH:mm').format(DateTime.now())}',
                    style: const pw.TextStyle(fontSize: 8),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );

    await Printing.layoutPdf(
      onLayout: (PdfPageFormat format) async {
        final output = await pdf.save();
        return output;
      },
      name: 'كشف حساب $safeCustomerName.pdf',
    );
  }

  pw.Widget _buildHeaderCell(String text) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(8),
      child: pw.Text(
        text,
        style: pw.TextStyle(fontWeight: pw.FontWeight.bold),
        textAlign: pw.TextAlign.center,
      ),
    );
  }

  pw.Widget _buildDataCell(String text) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(8),
      child: pw.Text(text, textAlign: pw.TextAlign.center),
    );
  }

  String _formatCellValue(dynamic value) {
    if (value == null) return 'غير متوفر';
    if (value is double || value is int) {
      return _formatCurrency(value.toDouble());
    }
    if (value is DateTime) {
      return DateFormat('dd/MM/yyyy').format(value);
    }
    if (value is String) {
      return value.isEmpty ? 'غير متوفر' : value;
    }
    return value.toString();
  }

  String _formatCurrency(double amount) {
    if (amount.isNaN) return '0.00 ج.م';
    return NumberFormat.currency(
      locale: 'en_EG',
      symbol: 'ج.م',
      decimalDigits: 2,
    ).format(amount);
  }

  // Cash Report Export Methods
  Future<void> exportCashReportToPDF(Map<String, dynamic> reportData) async {
    // Validate report data
    final safeOpeningBalance = reportData['openingBalance']?.toDouble() ?? 0.0;
    final safeTotalIncome = reportData['totalIncome']?.toDouble() ?? 0.0;
    final safeTotalExpenses = reportData['totalExpenses']?.toDouble() ?? 0.0;
    final safeVisaIncome = reportData['visaIncome']?.toDouble();
    final safeClosingBalance = reportData['closingBalance']?.toDouble() ?? 0.0;
    final safeTransactions =
        (reportData['transactions'] as List?)?.cast<Map<String, dynamic>>() ??
        [];

    final pdf = pw.Document();

    // Load Arabic fonts
    final arabicFont = await pw.Font.ttf(await rootBundle.load('assets/fonts/NotoSansArabic-Regular.ttf'));
    final arabicBoldFont = await pw.Font.ttf(await rootBundle.load('assets/fonts/NotoSansArabic-Bold.ttf'));

    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.all(32),
        build: (pw.Context context) => pw.Column(
          children: [
            // Header
            pw.Center(
              child: pw.Column(
                children: [
                  pw.Text(
                    'كشف النقدية',
                    style: pw.TextStyle(
                      fontSize: 24,
                      fontWeight: pw.FontWeight.bold,
                      font: arabicBoldFont,
                    ),
                  ),
                  pw.Text(
                    _branding,
                    style: pw.TextStyle(
                      fontSize: 10,
                      fontStyle: pw.FontStyle.italic,
                      font: arabicFont,
                    ),
                  ),
                  ),
                  pw.SizedBox(height: 16),
                  pw.Text(
                    'التاريخ: ${DateFormat('yyyy/MM/dd HH:mm').format(DateTime.now())}',
                    style: pw.TextStyle(font: arabicFont),
                  ),
                  pw.SizedBox(height: 16),
                  pw.Text(
                    'الرصيد الافتتاحي: ${_formatCurrency(safeOpeningBalance)} ج.م',
                    style: pw.TextStyle(font: arabicFont),
                  ),
                  pw.SizedBox(height: 16),
                  pw.Text(
                    'إجمالي الإيرادات: ${_formatCurrency(safeTotalIncome)} ج.م',
                    style: pw.TextStyle(font: arabicFont),
                  ),
                  pw.SizedBox(height: 16),
                  pw.Text(
                    'إجمالي المصروفات: ${_formatCurrency(safeTotalExpenses)} ج.م',
                    style: pw.TextStyle(font: arabicFont),
                  ),
                  pw.SizedBox(height: 16),
                  if (safeVisaIncome != null) ...[
                    pw.Text(
                      'إجمالي الفيزا: ${_formatCurrency(safeVisaIncome)} ج.م',
                      style: pw.TextStyle(font: arabicFont),
                    ),
                    pw.SizedBox(height: 16),
                  ],
                  pw.Text(
                    'الرصيد المغلق: ${_formatCurrency(safeClosingBalance)} ج.م',
                    style: pw.TextStyle(font: arabicFont),
                  ),
                ],
              ),
            ),
            pw.SizedBox(height: 20),

            // Transactions Table
            pw.TableHelper.fromTextArray(
              context: context,
              data: <List<String>>[
                ['الوقت', 'الوصف', 'دين (+)', 'دائن (-)', 'طريقة الدفع'],
                for (var transaction in safeTransactions)
                  [
                    transaction['time']?.toString() ?? 'غير متوفر',
                    transaction['description']?.toString() ?? 'غير متوفر',
                    transaction['debit']?.toString() ?? '0.00',
                    transaction['credit']?.toString() ?? '0.00',
                    transaction['paymentMethod']?.toString() ?? 'غير محدد',
                  ],
              ],
            ),

            pw.Expanded(child: pw.Container()),

            // Footer
            pw.Center(
              child: pw.Column(
                children: [
                  pw.Text(_branding),
                  pw.Text(
                    'تم الإنشاء في ${DateFormat('yyyy/MM/dd HH:mm').format(DateTime.now())}',
                    style: const pw.TextStyle(fontSize: 8),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );

    final output = await pdf.save();

    // Try different printing approaches
    try {
      await Printing.layoutPdf(
        onLayout: (PdfPageFormat format) async => output,
        name:
            'cash_report_${DateFormat('yyyyMMdd_HHmmss').format(DateTime.now())}',
      );
    } catch (e) {
      try {
        await Printing.sharePdf(
          bytes: output,
          filename:
              'cash_report_${DateFormat('yyyyMMdd_HHmmss').format(DateTime.now())}.pdf',
        );
      } catch (e2) {
        // Save to file as fallback
        final directory = await getApplicationDocumentsDirectory();
        final filePath = path.join(
          directory.path,
          'cash_report_${DateFormat('yyyyMMdd_HHmmss').format(DateTime.now())}.pdf',
        );
        final file = File(filePath);
        await file.writeAsBytes(output);
      }
    }
  }

  Future<void> exportSalesReportToExcel(
    List<Invoice> invoices,
    List<Customer> customers,
  ) async {
    // Validate inputs
    final safeInvoices = invoices.toList();

    final data = safeInvoices.map((invoice) {
      return {
        'رقم الفاتورة': invoice.id.toString(),
        'العميل': invoice.customerName.isNotEmpty
            ? invoice.customerName
            : 'عميل غير محدد',
        'التاريخ': DateFormat('yyyy/MM/dd').format(invoice.date),
        'الإجمالي': invoice.totalAmount.isNaN ? 0.0 : invoice.totalAmount,
        'المدفوع': invoice.paidAmount.isNaN ? 0.0 : invoice.paidAmount,
        'المتبقي':
            (invoice.totalAmount.isNaN ? 0.0 : invoice.totalAmount) -
            (invoice.paidAmount.isNaN ? 0.0 : invoice.paidAmount),
        'طريقة الدفع': invoice.paymentMethod?.isNotEmpty == true
            ? invoice.paymentMethod!
            : 'كاش',
        'الحالة': invoice.status.isNotEmpty == true
            ? invoice.status
            : 'غير محدد',
      };
    }).toList();

    await exportToExcel(
      title: 'تقرير المبيعات',
      data: data,
      headers: [
        'رقم الفاتورة',
        'العميل',
        'التاريخ',
        'الإجمالي',
        'المدفوع',
        'المتبقي',
        'طريقة الدفع',
        'الحالة',
      ],
      columns: [
        'رقم الفاتورة',
        'العميل',
        'التاريخ',
        'الإجمالي',
        'المدفوع',
        'المتبقي',
        'طريقة الدفع',
        'الحالة',
      ],
      fileName:
          'sales_report_${DateFormat('yyyyMMdd_HHmmss').format(DateTime.now())}',
    );
  }
}
